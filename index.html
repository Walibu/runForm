<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script type="text/javascript">
    let distance = 1000;
    const limit0 = 0;
    const limit1 = 70;
    const limit2 = 83;
    const limit3 = 93;
    const limit4 = 103;
    const limitX = 999;
    const minThreshold = 10; // 10 Meter pro 10s
    const maxThreshold = 100; // 100 Meter pro 10s

function initValues() {
    const params = new URLSearchParams(document.location.search.substring(1));
    distance = parseInt(params.get("distance"));
    if (distance && distance > 0) {
        document.getElementsByName('distance')[0].value = distance;
    } else {
        updateDistance();   
    }
    if( supports_html5_storage() == true ) {
        let savedUsers = localStorage.getItem("allUsers");
        let myUsers = null;
        if (savedUsers) {
            myUsers = savedUsers.split(',');
        }
        if (myUsers && myUsers.length > 0) {
            setName(myUsers[0]);
            updateUserList(myUsers);
            initUserData();
            setDeleteButtonName(myUsers[0]);
        } else {
            myUsers = [""];
            localStorage.setItem("allUsers", myUsers);
            updateUserList(myUsers);
        }
    } else {
        document.getElementById('userchoice').disabled = "disabled";
        document.getElementById('savebutton').disabled = "disabled";
        document.getElementById('deletebutton').disabled = "disabled";
        document.getElementById('userchoice').title = "not supported by browser";
        document.getElementById('savebutton').title = "not supported by browser";
        document.getElementById('deletebutton').title = "not supported by browser";
    }
}
function updateUserList(users) {
    let userList = document.getElementsByName('identityList')[0];
    userList.innerHTML = "";
    for (let i = 0; i < users.length; i++) {
        userList.innerHTML += '<option value="' + users[i] + '">' + users[i] + '</option>\n';
    }
    if (users.length > 0) {
        userList.disabled = "";
    } else {
        userList.disabled = "disabled";
    }
}
function supports_html5_storage() {
    try {
        return 'localStorage' in window && window['localStorage'] !== null;
    } catch (e) {
        return false;
    }
}

function updateDistance() {
    distance = document.getElementsByName('distance')[0].value;
    if (!distance || !(distance > 0)) {
        distance = document.getElementsByName('distance')[0].value = 1000;
    }
}
function initUserData() {
    if( supports_html5_storage() == true ) {
        let name = getName();
        
        let savedUserData = localStorage.getItem(name);
        let userData = null;
        if (savedUserData) {
            userData = savedUserData.split(',');
        }
        if (userData && userData.length > 9) {
            document.getElementsByName("veryeasy-min")[0].value = userData[0];
            document.getElementsByName("veryeasy-sec")[0].value = userData[1];
            document.getElementsByName("easy-min")[0].value = userData[2];
            document.getElementsByName("easy-sec")[0].value = userData[3];
            document.getElementsByName("moderate-min")[0].value = userData[4];
            document.getElementsByName("moderate-sec")[0].value = userData[5];
            document.getElementsByName("fast-min")[0].value = userData[6];
            document.getElementsByName("fast-sec")[0].value = userData[7];
            document.getElementsByName("maxspeed-min")[0].value = userData[8];
            document.getElementsByName("maxspeed-sec")[0].value = userData[9];
            calc();
        }
    }
}
function saveUserData() {
    calc();
    if (supports_html5_storage() == true ) {
        let myUsers = localStorage.getItem("allUsers").split(',');
        let name = getName();
        if (myUsers) {
            if (!myUsers.includes(name)) {
                myUsers.push(name);
                localStorage.setItem("allUsers", myUsers);
                updateUserList(myUsers);
            }
        } else {
            localStorage.setItem("allUsers", [name]);
            updateUserList([name]);
        }
        selectUserName(name);
        localStorage.setItem(name, [
            document.getElementsByName("veryeasy-min")[0].value,
            document.getElementsByName("veryeasy-sec")[0].value,
            document.getElementsByName("easy-min")[0].value,
            document.getElementsByName("easy-sec")[0].value,
            document.getElementsByName("moderate-min")[0].value,
            document.getElementsByName("moderate-sec")[0].value,
            document.getElementsByName("fast-min")[0].value,
            document.getElementsByName("fast-sec")[0].value,
            document.getElementsByName("maxspeed-min")[0].value,
            document.getElementsByName("maxspeed-sec")[0].value
            ]
        );
        resetInputData();
    }
}
function resetInputData() {
    setName("");
    setDeleteButtonName("")
    document.getElementsByName("veryeasy-min")[0].value = "";
    document.getElementsByName("veryeasy-sec")[0].value = "";
    document.getElementsByName("easy-min")[0].value = "";
    document.getElementsByName("easy-sec")[0].value = "";
    document.getElementsByName("moderate-min")[0].value = "";
    document.getElementsByName("moderate-sec")[0].value = "";
    document.getElementsByName("fast-min")[0].value = "";
    document.getElementsByName("fast-sec")[0].value = "";
    document.getElementsByName("maxspeed-min")[0].value = "";
    document.getElementsByName("maxspeed-sec")[0].value = "";
}
function selectUserName(name) {
    document.getElementsByName("identityList")[0].value = name;
    setDeleteButtonName(name);
}

function deleteUserData() {
    let deleteName = getName();
    var result = confirm("'" + deleteName + "' löschen?");
    if (result) {
        localStorage.removeItem(deleteName);
        let myUsers = localStorage.getItem("allUsers").split(',');
        localStorage.setItem("allUsers", myUsers.filter(name => name !== deleteName));
        //localStorage.clear();
        initValues();
    }
}

function setColor(name, value, lowerLimit, upperLimit) {
    if (value > lowerLimit && value < upperLimit) {
        document.getElementById(name).style.backgroundColor = "lightgreen";
    } else {
        document.getElementById(name).style.backgroundColor = "lightgrey";
    }
}

function getPace(name) {
    let time = (60 * document.getElementsByName(name + "-min")[0].value + 
        Number(document.getElementsByName(name + "-sec")[0].value));
    if (time > 0) {
        // Meter pro 10 Sekunden
        return 10 * distance / time;
    } else {
        return 0;
    }
}

function getPercent(pace, threshold) {
    if (threshold > 0) {
        return Math.round(pace * 1000 / threshold) / 10;
    } else {
        return 0;
    }
}

function getName() {
    return document.getElementsByName("identity")[0].value
}
function setName(nameStr) {
    document.getElementsByName("identity")[0].value = nameStr;
}
function changeName() {
    let name = document.getElementsByName("identityList")[0].value;
    document.getElementsByName("identity")[0].value = name;
    initUserData();
    setDeleteButtonName(name);
}
function setDeleteButtonName(name) {
    document.getElementById('deletebutton').innerHTML = "'" + name + "' löschen";
}

function calc() {
    updateDistance();

    let veryeasy = getPace("veryeasy");
    let easy = getPace("easy");
    let moderate = getPace("moderate");
    let fast = getPace("fast");
    let maxspeed = getPace("maxspeed");
               
    let matchThresholdUp = 0;
    let matchThresholdDown = 0;
    let matchCount = 0;
    let count = 0;
    
    // threshold Wert ist in Meter pro 10 Sekunden, analog der Funktion getPace()
    for (let threshold = minThreshold; threshold < maxThreshold; threshold++) {
        count = 0;
        if (veryeasy < threshold * limit1 / 100) count++;
        if (easy > threshold * limit1 / 100 && easy < threshold * limit2 / 100) count++;
        if (moderate > threshold * limit2 / 100 && moderate < threshold * limit3 / 100) count++;
        if (fast > threshold * limit3 / 100 && fast < threshold * limit4 / 100) count++;
        if (maxspeed > threshold * limit4 / 100) count++;
        if (count > matchCount) {
            matchCount = count;
            matchThresholdUp = threshold;
        }
    }
    matchCount = 0;
    // Gleiche Annäherung wie oben, aber von maxThreshold her Richtung kleinere Werte
    for (let threshold = maxThreshold; threshold > minThreshold; threshold--) {
        count = 0;
        if (veryeasy < threshold * limit1 / 100) count++;
        if (easy > threshold * limit1 / 100 && easy < threshold * limit2 / 100) count++;
        if (moderate > threshold * limit2 / 100 && moderate < threshold * limit3 / 100) count++;
        if (fast > threshold * limit3 / 100 && fast < threshold * limit4 / 100) count++;
        if (maxspeed > threshold * limit4 / 100) count++;
        if (count > matchCount) {
            matchCount = count;
            matchThresholdDown = threshold;
        }
    }
    // Mittelwert von beiden besten gefundenen Werten
    let matchThreshold = (matchThresholdUp + matchThresholdDown) / 2;

    document.getElementById('veryeasy-per').innerHTML = getPercent(veryeasy, matchThreshold) + "%";
    document.getElementById('easy-per').innerHTML = getPercent(easy, matchThreshold) + "%";
    document.getElementById('moderate-per').innerHTML = getPercent(moderate, matchThreshold) + "%";
    document.getElementById('fast-per').innerHTML = getPercent(fast, matchThreshold) + "%";
    document.getElementById('maxspeed-per').innerHTML = getPercent(maxspeed, matchThreshold) + "%";
    
    setColor("veryeasy-per", getPercent(veryeasy, matchThreshold), limit0, limit1);
    setColor("easy-per", getPercent(easy, matchThreshold), limit1, limit2);
    setColor("moderate-per", getPercent(moderate, matchThreshold), limit2, limit3);
    setColor("fast-per", getPercent(fast, matchThreshold), limit3, limit4);
    setColor("maxspeed-per", getPercent(maxspeed, matchThreshold), limit4, limitX);
    
    if (matchCount < 3) {
        matchThreshold = 0;
    }
    document.getElementById('threshold').innerHTML = getMinPerKm(matchThreshold);
    setColor("threshold", matchThreshold, minThreshold, maxThreshold);
}
function getMinPerKm(pace) {
    if (pace > 0) {
        return Math.floor(10000 / pace / 60) + " : " + Math.round(10000 / pace % 60);
    } else {
        return "-";
    }
}
</script>

<style type="text/css">
* {
    font-family: Helvetica;
}
table {
    border-collapse: collapse;
}
tr {
    border: 5px white solid;
}
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
input[type="number"] {
    -moz-appearance: textfield;
    width: 3em;
    text-align: right;
}
.name-input {
    text-align: left;
}
.name-input input {
    width: 9em;
}
.row-time input {
    width: 1.5em;
}
.row-header, .row-time, .row-result {
    padding: 1em;
}
.row-header {
    background-color: lightgray;
}
.row-time {
}
.row-result {
    background-color: lightgray;
}
.col-1, .col-2, .col-3, .col-4 {
    padding: 0.3em;
    white-space: nowrap;
}
.row-time .col-3 {
    padding-left: 3em;
}
.col-3, .col-4 {
    text-align: right;
}
.part-result {
    width: 4em;
    padding: 0.3em 0.5em;
    text-align: right;
    background-color: lightgrey;
}
#threshold {
    font-weight: bold;
    text-align: center;
    border: 2px solid green;
    padding: 0.3em 0.5em;
}
.footer {
    padding: 1em 0;
}
</style>

</head>

<body onload="initValues()">
<table>
<tr class="row-header">
    <td class="col-1">Distanz<br />
        <input type="number" name="distance" min="500" max="2000" onchange="calc()" /> m
    </td>
    <td class="col-3" colspan="2">
        <div class="name-input">
            Läufer Name<br />
            <input type="text" name="identity" />
        </div>
    </td>
    <td class="col-4">
        Gespeicherte Daten<br />
        <select id="userchoice" name="identityList" onchange="changeName()" onclick="changeName()">
        </select>
    </td>
</tr>
<tr class="row-time">
    <td class="col-1">sehr locker</td>
    <td class="col-2">
        <input type="number" name="veryeasy-min" min="2" max="10" onchange="calc()" /> :
        <input type="number" name="veryeasy-sec" min="0" max="60" onchange="calc()" /> s
    </td>
    <td class="col-3"><div class="part-result" id="veryeasy-per">-</td>
    <td class="col-4"> (< 70%)</td>
</tr><tr class="row-time">
    <td class="col-1">locker</td>
    <td class="col-2">
        <input type="number" name="easy-min" min="2" max="10" onchange="calc()" /> :
        <input type="number" name="easy-sec" min="0" max="60" onchange="calc()" /> s
    </td>
    <td class="col-3"><div class="part-result" id="easy-per">-</td>
    <td class="col-4"> (70% - 83%)</td>
</tr><tr class="row-time">
    <td class="col-1">zügig</td>
    <td class="col-2">
        <input type="number" name="moderate-min" min="2" max="10" onchange="calc()" /> :
        <input type="number" name="moderate-sec" min="0" max="60" onchange="calc()" /> s
    </td>
    <td class="col-3"><div class="part-result" id="moderate-per">-</td>
    <td class="col-4"> (83% - 93%)</td>
</tr><tr class="row-time">
    <td class="col-1">schnell</td>
    <td class="col-2">
        <input type="number" name="fast-min" min="2" max="10" onchange="calc()" /> :
        <input type="number" name="fast-sec" min="0" max="60" onchange="calc()" /> s
    </td>
    <td class="col-3"><div class="part-result" id="fast-per">-</td>
    <td class="col-4"> (93% - 103%)</td>
</tr><tr class="row-time">
    <td class="col-1">maximal</td>
    <td class="col-2">
        <input type="number" name="maxspeed-min" min="2" max="10" onchange="calc()" /> :
        <input type="number" name="maxspeed-sec" min="0" max="60" onchange="calc()" /> s
    </td>
    <td class="col-3"><div class="part-result" id="maxspeed-per">-</div></td>
    <td class="col-4"> (> 103%)</td>
</tr>
<tr class="row-result">
    <td class="col-1">Schwelle (min/km)</td>
    <td class="col-2"><div id="threshold">--</div></td>
    <td class="col-3"><Button id="savebutton" onclick="saveUserData()">Daten speichern</Button></td>
    <td class="col-4"><Button id="deletebutton" onclick="deleteUserData()">löschen</Button></td>
</tr>
</table>
<div class="footer">
    <!--<a href="./index.html" download="lauftest.html">Download</a><br />-->
    Das Formular ist auch offline nutzbar.
</div>
</body>
</html>
